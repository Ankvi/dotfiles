#!/usr/bin/env python

import dbus
from sys import argv

class SpotifyNotRunningError(Exception):
    pass

class CouldNotConnectToSpotifyError(Exception):
    pass

class MultipleSpotifyInstancesError(Exception):
    pass

class InvalidCommandError(Exception):
    pass

DBUS_OBJECT_PATH = '/org/mpris/MediaPlayer2'
DBUS_PROPERTIES_INTERFACE = 'org.freedesktop.DBus.Properties'
DBUS_PLAYER_INTERFACE = 'org.mpris.MediaPlayer2.Player'

class SpotifyModule:
    def __init__(self):
        self.bus = dbus.SessionBus()

        self.spotifyd_mpris_instance = None
        self.spotifyd = None
        self.properties = None
        self.player = None

        for service in self.bus.list_names():
            if "spotify" in service:
                if self.spotifyd_mpris_instance is not None:
                    raise MultipleSpotifyInstancesError
                self.spotifyd_mpris_instance = service

        if self.spotifyd_mpris_instance is not None:
            self.spotifyd = self.bus.get_object(self.spotifyd_mpris_instance, DBUS_OBJECT_PATH, False)

        if self.spotifyd is not None:
            self.properties = dbus.Interface(self.spotifyd, DBUS_PROPERTIES_INTERFACE)
            self.player = dbus.Interface(self.spotifyd, DBUS_PLAYER_INTERFACE)

    def get_song_info(self):
        if self.properties is None:
            raise CouldNotConnectToSpotifyError

        metadata = self.properties.Get(DBUS_PLAYER_INTERFACE, 'Metadata')
        title = metadata.get('xesam:title', 'Unknown title')
        artists = metadata.get('xesam:artist', ['Unknown artists'])
        artist = ", ".join(artists)
        return f'{artist} - {title}'

    def get_status(self):
        if self.properties is None:
            raise CouldNotConnectToSpotifyError

        return self.properties.Get(DBUS_PLAYER_INTERFACE, 'PlaybackStatus')

    def print_song_info(self):
        status = self.get_status()
        match status:
            case 'Playing' | 'Paused':
                song_info = self.get_song_info()
                print(song_info)
            case _:
                print('Spotify')

    def print_is_playing_icon(self):
        try:
            print("" if self.get_status() == 'Playing' else "")
        except CouldNotConnectToSpotifyError:
            print("")

if __name__ == '__main__':
    try:
        spotify_module = SpotifyModule()

        if len(argv) < 2:
            spotify_module.print_song_info()
            exit()

        command = argv[1]
        match command:
            case 'play_pause':
                spotify_module.player.PlayPause()
            case 'print_song_info':
                spotify_module.print_song_info()
            case 'print_is_playing_icon':
                spotify_module.print_is_playing_icon()
            case 'next':
                spotify_module.player.Next()
            case 'previous':
                spotify_module.player.Previous()
            case 'status':
                print(spotify_module.get_status())

    except SpotifyNotRunningError:
        print('Spotify is not running')
    except CouldNotConnectToSpotifyError:
        print('Could not connect to Spotify')
    except InvalidCommandError:
        print('Invalid command')
    except MultipleSpotifyInstancesError:
        print('Multiple Spotifyd instances found')
    except Exception as e:
        print(f'Unknown error: {e}')
